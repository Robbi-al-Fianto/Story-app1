(()=>{"use strict";var e,t={683:(e,t,n)=>{class a{baseTemplate(e,t){return`\n      <section class="container">\n        <header class="home-header" style="display:flex; justify-content:space-between; align-items:center;">\n          <h1 class="page-title" style="margin:0;">Welcome, ${t}</h1>\n          \x3c!-- Tombol Tambah Story untuk semua, guest atau login --\x3e\n          <button id="add-btn" class="btn btn-primary">\n            Tambah Story\n          </button>\n        </header>\n        ${e?this._guestWarning():'\n            <div id="map" class="map-container" style="height:400px; margin:1rem 0;"></div>\n            <div class="story-grid"></div>\n            <div id="loading" class="loading-indicator" style="display:none; text-align:center; margin-top:1rem;">\n              <p>Loading…</p>\n            </div>\n          '}\n      </section>\n    `}storyCard(e){return`\n         <a href="#/stories/${e.id}" class="story-link">\n           <article class="story-card">\n             <img src="${e.photoUrl}" alt="${e.name}" class="story-image">\n             <div class="story-content">\n               <h3 class="story-title">${e.name}</h3>\n               <p class="story-description">${e.description}</p>\n               <time class="story-date">\n                 ${new Date(e.createdAt).toLocaleDateString()}\n               </time>\n             </div>\n           </article>\n         </a>\n       `}_guestWarning(){return'\n      <div class="guest-warning">\n        <p>✨ Anda masuk sebagai Guest. Anda hanya bisa menambahkan cerita.</p>\n        <a href="#/login" class="btn btn-secondary">Login untuk lihat cerita</a>\n      </div>\n    '}errorTemplate(e){return`\n      <div class="error">\n        <h2>Error!</h2>\n        <p>${e}</p>\n      </div>\n    `}}var i=n(481),r=n.n(i);class s{constructor(e,t={}){this.containerId=e,this.center=t.center||[-6.2,106.8166],this.zoom=t.zoom||5,this.map=null,this.markerLayer=null,this._clickCb=null}init(){const e=document.getElementById(this.containerId);e?(e.innerHTML="",this.map&&(this.map.remove(),this.map=null),this.map=r().map(this.containerId).setView(this.center,this.zoom),r().tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(this.map),this.markerLayer=r().layerGroup().addTo(this.map),this._clickCb&&this.map.on("click",(e=>this._onMapClick(e.latlng)))):console.error(`Map container #${this.containerId} tidak ditemukan`)}onClick(e){this._clickCb=e}_onMapClick(e){this.markerLayer.clearLayers(),r().marker(e).addTo(this.markerLayer),this._clickCb?.(e)}addMarkers(e){this.map&&(this.markerLayer.clearLayers(),e.forEach((e=>{if(null!=e.lat&&null!=e.lon){const t=r().marker([e.lat,e.lon]);e.popupHtml&&t.bindPopup(e.popupHtml),t.addTo(this.markerLayer)}})))}destroy(){this.map&&(this.map.remove(),this.map=null)}}class o{constructor(e){this.template=e,this.mapView=null}bindAddButton(e){document.addEventListener("click",(t=>{if(t.target.matches("#add-btn")||t.target.matches("#guest-add-btn")){t.preventDefault();const n=!localStorage.getItem("token")&&"true"===localStorage.getItem("isGuest");e(n)}}))}showLoading(){const e=document.getElementById("loading");e&&(e.style.display="block")}hideLoading(){const e=document.getElementById("loading");e&&(e.style.display="none")}showError(e){const t=document.querySelector(".container");t&&(t.innerHTML=this.template.errorTemplate(e))}renderStories(e){const t=document.querySelector(".story-grid");t&&(t.innerHTML=e.length?e.map((e=>this.template.storyCard(e))).join(""):"<p>Belum ada cerita.</p>")}initializeMap(e){this.mapView||(this.mapView=new s("map",{center:[-6.2,106.8166],zoom:5})),this.mapView.init();const t=e.map((e=>({lat:e.lat,lon:e.lon,popupHtml:`<b>${e.name}</b><br>${e.description}`})));this.mapView.addMarkers(t)}}var l=n(602);const c="stories",d="drafts",m="comments";function u(){return(0,l.P2)("story-app-db",2,{upgrade(e){e.objectStoreNames.contains(c)||e.createObjectStore(c,{keyPath:"id"}),e.objectStoreNames.contains(d)||e.createObjectStore(d,{keyPath:"id"}),e.objectStoreNames.contains(m)||e.createObjectStore(m,{keyPath:"cid"}).createIndex("by_story","storyId")}})}async function h(e){return(await u()).put(d,e)}async function p(){return(await u()).getAll(d)}async function g(e){return(await u()).delete(d,e)}async function v(e){return(await u()).getAllFromIndex(m,"by_story",e)}class y{constructor(e,t){this.view=e,this.storyService=t}async initialize(){if(localStorage.getItem("token")||"true"!==localStorage.getItem("isGuest")){this.view.showLoading();try{const e=await this.storyService.getAllStories({location:1});await async function(e=[]){const t=(await u()).transaction(c,"readwrite");e.forEach((e=>t.store.put(e))),await t.done}(e),this.view.initializeMap(e),this.view.renderStories(e)}catch(e){const t=await async function(){return(await u()).getAll(c)}();t.length?(this.view.initializeMap(t),this.view.renderStories(t)):this.view.showError("Tidak dapat memuat cerita, coba lagi nanti.")}finally{this.view.hideLoading()}}}async cleanup(){this.view.mapView?.destroy()}}class w{render(){return'\n      <section class="container">\n        <div class="story-form-card">\n          <h1 class="page-title">Tambah Story Baru</h1>\n          <form id="storyForm" class="story-form">\n            \x3c!-- FOTO & controls --\x3e\n            <div class="form-group">\n              <label for="photo">Foto</label>\n              <div class="photo-buttons">\n                <button type="button" id="open-camera" class="btn btn-secondary">\n                  Buka Kamera\n                </button>\n                <button type="button" id="close-camera" class="btn btn-secondary" hidden>\n                  Tutup Kamera\n                </button>\n                <button type="button" id="upload-photo" class="btn btn-secondary">\n                  Upload Gambar\n                </button>\n              </div>\n              <input type="file" id="photo" hidden required />\n\n              \x3c!-- Preview Kamera --\x3e\n              <div class="camera-container" hidden>\n                <video id="camera-preview" autoplay playsinline class="camera-preview"></video>\n                <button type="button" id="capture-photo" class="capture-button">\n                  Ambil Foto\n                </button>\n              </div>\n\n              \x3c!-- Preview Hasil --\x3e\n              <div class="photo-preview-container" hidden>\n                <img id="photo-preview" class="photo-preview" alt="Preview Foto"/>\n                <button type="button" id="remove-photo" class="remove-photo-button">×</button>\n              </div>\n            </div>\n            \x3c!-- DESKRIPSI --\x3e\n            <div class="form-group">\n              <label for="description">Deskripsi</label>\n              <textarea id="description" required></textarea>\n            </div>\n            \x3c!-- LOKASI --\x3e\n            <div class="form-group">\n              <label for="locationMap">Pilih Lokasi</label>\n              <div id="locationMap" class="map-embed" style="height:300px;"></div>\n              <input type="hidden" id="lat" required />\n              <input type="hidden" id="lon" required />\n            </div>\n\n            <div id="form-error" class="form-error" hidden></div>\n            \x3c!-- SUBMIT --\x3e\n            <button type="submit" class="btn btn-primary w-100">\n              Publikasikan\n            </button>\n              <button type="button" id="save-draft-btn">Simpan Draft</button>\n          </form>\n        </div>\n      </section>\n    '}detailTemplate(){return'\n      <section class="container story-detail">\n        <div id="story-map" class="story-map" style="height:300px;"></div>\n        <div class="story-info">\n          <h2 id="story-title"></h2>\n          <img id="story-image" alt="" class="story-img"/>\n          <p id="story-desc"></p>\n          <time id="story-date"></time>\n        </div>\n  \n       \x3c!-- KOMENTAR --\x3e\n       <section class="comments-section">\n         <h3>Komentar</h3>\n         <ul id="comment-list" class="comment-list"></ul>\n         <form id="commentForm" class="comment-form">\n           <input \n             type="text" \n             id="comment-input" \n             placeholder="Tulis komentar..." \n             required\n           />\n           <button type="submit" class="btn btn-primary">Kirim</button>\n         </form>\n       </section>\n      </section>\n    '}}class b{constructor(e){this.template=e,this.mapView=null,this.handlers={}}render(){return this.template.render()}initMap(e){this.mapView=new s("locationMap",{center:[-6.1754,106.8272],zoom:5}),this.mapView.onClick(e),this.mapView.init()}bindCamera({open:e,close:t,capture:n,upload:a,remove:i,onFileChange:r}){const s=document.getElementById("open-camera"),o=document.getElementById("close-camera"),l=document.getElementById("capture-photo"),c=document.getElementById("upload-photo"),d=document.getElementById("remove-photo"),m=document.getElementById("photo");s.addEventListener("click",e),o.addEventListener("click",t),l.addEventListener("click",n),c.addEventListener("click",a),d.addEventListener("click",i),m.addEventListener("change",r)}bindSubmit(e){document.getElementById("storyForm").addEventListener("submit",e)}showAlert(e){alert(e)}bindSaveDraft(e){document.getElementById("save-draft-btn").addEventListener("click",e)}getDescription(){return document.getElementById("description").value}getLat(){return document.getElementById("lat").value}getLon(){return document.getElementById("lon").value}getPhotoFile(){return document.getElementById("photo").files[0]}showErrorMessage(e){const t=document.getElementById("form-error");t&&(t.textContent=e,t.hidden=!1)}hideErrorMessage(){const e=document.getElementById("form-error");e&&(e.hidden=!0)}}var f=n(279);class S{constructor(e,{storyService:t,navigate:n}){this.view=e,this.storyService=t,this.navigate=n,this.cameraStream=null}init(){const e="true"===localStorage.getItem("isGuest");if(!localStorage.getItem("token")&&!e)return this.view.showAlert("Anda perlu login atau lanjut sebagai Guest"),this.navigate("/login");this.view.initMap((e=>{document.getElementById("lat").value=e.lat,document.getElementById("lon").value=e.lng})),this.view.bindCamera({open:()=>this._openCamera(),close:()=>this._stopCamera(),capture:()=>this._capturePhoto(),upload:()=>document.getElementById("photo").click(),remove:()=>this._removePhoto(),onFileChange:()=>this._onFileChange()}),this.view.bindSubmit((e=>this._handleSubmit(e))),this.view.bindSaveDraft((()=>this.handleSaveDraft()))}async _openCamera(){try{this.cameraStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}),document.getElementById("camera-preview").srcObject=this.cameraStream,document.querySelector(".camera-container").hidden=!1,document.getElementById("capture-photo").hidden=!1,document.getElementById("open-camera").hidden=!0,document.getElementById("upload-photo").hidden=!0,document.getElementById("close-camera").hidden=!1}catch(e){this.view.showAlert("Gagal akses kamera: "+e.message)}}_stopCamera(){this.cameraStream&&(this.cameraStream.getTracks().forEach((e=>e.stop())),this.cameraStream=null),document.querySelector(".camera-container").hidden=!0,document.getElementById("capture-photo").hidden=!0,document.getElementById("close-camera").hidden=!0,document.getElementById("open-camera").hidden=!1,document.getElementById("upload-photo").hidden=!1}_capturePhoto(){const e=document.getElementById("camera-preview"),t=document.createElement("canvas");t.width=e.videoWidth,t.height=e.videoHeight,t.getContext("2d").drawImage(e,0,0),t.toBlob((e=>{const t=new File([e],"photo.jpg",{type:"image/jpeg"}),n=new DataTransfer;n.items.add(t),document.getElementById("photo").files=n.files,document.getElementById("photo-preview").src=URL.createObjectURL(t),document.querySelector(".photo-preview-container").hidden=!1,this._stopCamera()}),"image/jpeg",.9)}_removePhoto(){document.getElementById("photo").value="",document.getElementById("photo-preview").src="",document.querySelector(".photo-preview-container").hidden=!0}_onFileChange(){const e=document.getElementById("photo");e.files.length&&(document.getElementById("photo-preview").src=URL.createObjectURL(e.files[0]),document.querySelector(".photo-preview-container").hidden=!1,this._stopCamera())}async handleSaveDraft(){const e=this.view.getDescription().trim(),t=this.view.getLat(),n=this.view.getLon(),a=this.view.getPhotoFile();if(!e||!a)return this.view.showAlert("Deskripsi dan foto wajib diisi.");const i={id:(0,f.A)(),description:e,lat:t,lon:n,createdAt:(new Date).toISOString()};try{await h(i),this.view.showAlert("Draft berhasil disimpan!")}catch(e){this.view.showAlert("Gagal simpan draft: "+e.message)}}async handleSaveDraft(){const e=this.view.getDescription().trim(),t=this.view.getLat(),n=this.view.getLon(),a=this.view.getPhotoFile();if(!e||!a)return this.view.showAlert("Deskripsi dan foto wajib diisi.");const i={id:(0,f.A)(),description:e,lat:t,lon:n,createdAt:(new Date).toISOString()};try{await h(i),this.view.showAlert("Draft berhasil disimpan!")}catch(e){this.view.showAlert("Gagal simpan draft: "+e.message)}}async _handleSubmit(e){e.preventDefault(),this.view.hideErrorMessage();const t=document.getElementById("photo").files[0],n=document.getElementById("lat").value,a=document.getElementById("lon").value,i=document.getElementById("description").value.trim();if(!t)return this.view.showErrorMessage("📷 Gambar wajib diunggah.");if(t.size>1e6)return this.view.showErrorMessage("📸 Gambar terlalu besar. Maksimal 1MB.");if(!n||!a)return this.view.showErrorMessage("📍 Silakan pilih lokasi di peta.");const r=new FormData;r.append("photo",t),r.append("description",i),r.append("lat",n),r.append("lon",a);try{localStorage.getItem("token")?await this.storyService.addStory(r):await this.storyService.addStoryGuest(r),this.navigate("/")}catch(e){this.view.showAlert("Gagal kirim: "+e.message)}}async cleanup(){this.view.mapView?.destroy(),this.cameraStream&&this.cameraStream.getTracks().forEach((e=>e.stop()))}}class k{constructor(){this.form=document.getElementById("loginForm"),this.guestButton=document.querySelector(".guest-button")}getFormData(){return{email:document.getElementById("email").value,password:document.getElementById("password").value}}bindLogin(e){this.form.addEventListener("submit",(async t=>{t.preventDefault(),await e(this.getFormData())}))}bindGuestLogin(e){this.guestButton.addEventListener("click",(t=>{t.preventDefault(),e()}))}showError(e){const t=document.createElement("div");t.className="auth-error",t.textContent=e,this.form.prepend(t),setTimeout((()=>t.remove()),3e3)}}const I="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk";function E(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),n=atob(t);return Uint8Array.from([...n].map((e=>e.charCodeAt(0))))}const B="https://story-api.dicoding.dev/v1",D=async e=>{const t=await e.json();if(!e.ok){const e=t.message||(t.error?`${t.error} - ${t.message}`:"Request failed");throw new Error(e)}return t},T={async login({email:e,password:t}){const n=await fetch(`${B}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})}),a=await D(n);if(!a.loginResult?.token)throw new Error("Invalid response structure");return a},async register({name:e,email:t,password:n}){const a=await fetch(`${B}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:t,password:n})});return D(a)},async registerPush(e){const t=localStorage.getItem("token");if(!t)return;const n=e.toJSON(),a={endpoint:n.endpoint,keys:n.keys},i=await fetch(`${B}/notifications/subscribe`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(a)});return D(i)},async unregisterPush(){const e=localStorage.getItem("token"),t=localStorage.getItem("push-endpoint");if(!e||!t)return;const n=await fetch(`${B}/notifications/subscribe`,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({endpoint:t})}),a=await D(n);return localStorage.removeItem("push-endpoint"),a}},P={async getAllStories({page:e=1,size:t=20,location:n=1}={}){const a=localStorage.getItem("token"),i=new URL(`${B}/stories`);i.searchParams.set("page",e),i.searchParams.set("size",t),i.searchParams.set("location",n);const r=await fetch(i.toString(),{headers:a?{Authorization:`Bearer ${a}`}:{}});return(await D(r)).listStory||[]},async getStoryById(e){const t=localStorage.getItem("token"),n=await fetch(`${B}/stories/${e}`,{headers:t?{Authorization:`Bearer ${t}`}:{}});return(await D(n)).story},async addStory(e){const t=localStorage.getItem("token");if(!t)throw new Error("Authentication required");const n=await fetch(`${B}/stories`,{method:"POST",headers:{Authorization:`Bearer ${t}`},body:e});return D(n)},async addStoryGuest(e){const t=await fetch(`${B}/stories/guest`,{method:"POST",body:e});return D(t)}};class C{constructor(e,{authService:t,navigate:n}){this.view=e,this.authService=t,this.navigate=n}init(){this.view.bindLogin(this.handleLogin.bind(this)),this.view.bindGuestLogin(this.handleGuestLogin.bind(this))}async handleLogin(e){try{const t=await this.authService.login(e);if(localStorage.setItem("token",t.loginResult.token),localStorage.setItem("userName",t.loginResult.name),localStorage.removeItem("isGuest"),"Notification"in window&&"default"===Notification.permission&&await Notification.requestPermission(),"granted"===Notification.permission&&"serviceWorker"in navigator&&"PushManager"in window){const e=await navigator.serviceWorker.ready,t=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:E(I)});await this.authService.registerPush(t)}this.navigate("/")}catch(e){let t=e.message;t.includes("Failed to fetch")?t="Gagal terhubung ke server":t.toLowerCase().includes("invalid response structure")&&(t="Respons server tidak valid"),this.view.showError(t)}}handleGuestLogin(){localStorage.setItem("isGuest","true"),localStorage.removeItem("token"),localStorage.removeItem("userName"),this.navigate("/")}}class x{render(){return'\n      <section class="auth-container">\n        <div>\n          <h2 class="auth-title">Welcome to Story App</h2>\n          <form id="loginForm" class="auth-form">\n            <div class="form-group">\n              <label for="email">Email</label>\n              <input \n                type="email" \n                id="email"\n                placeholder="contoh@email.com"\n                required\n              >\n            </div>\n            <div class="form-group">\n              <label for="password">Password</label>\n              <input \n                type="password" \n                id="password"\n                placeholder="Masukkan password"\n                required\n              >\n            </div>\n            <button type="submit" class="btn btn-primary w-100">Sign In</button>\n          </form>\n          <div class="auth-links">\n            <p>Belum punya akun? <a href="#/register">Daftar di sini</a></p>\n            <button class="btn btn-secondary w-100 guest-button">Lanjut sebagai Guest</button>\n          </div>\n        </div>\n      </section>\n    '}}class M{render(){return'\n      <section class="auth-container">\n        <div class="auth-card">\n          <h2 class="auth-title">Daftar Akun Baru</h2>\n          <form id="registerForm" class="auth-form">\n            <div class="form-group">\n              <label for="name">Nama Lengkap</label>\n              <input type="text" id="name" placeholder="Masukkan nama lengkap" required />\n            </div>\n            <div class="form-group">\n              <label for="email">Email</label>\n              <input type="email" id="email" placeholder="contoh@email.com"\n                     required />\n            </div>\n            <div class="form-group">\n              <label for="password">Password</label>\n              <input type="password" id="password"\n                     placeholder="Minimal 8 karakter"\n                     minlength="8" required />\n            </div>\n            <button type="submit" class="btn btn-primary w-100">\n              Daftar Sekarang\n            </button>\n          </form>\n          <p class="auth-link">\n            Sudah punya akun? <a href="#/login">Login di sini</a>\n          </p>\n        </div>\n      </section>\n    '}}class A{constructor(e){this.template=e}render(){return this.template.render()}bindRegister(e){document.getElementById("registerForm").addEventListener("submit",(async t=>{t.preventDefault();const n=document.getElementById("name").value.trim(),a=document.getElementById("email").value.trim(),i=document.getElementById("password").value;e({name:n,email:a,password:i})}))}showError(e){alert(`Register gagal: ${e}`)}}class ${constructor(e,{authService:t,navigate:n}){this.view=e,this.authService=t,this.navigate=n}init(){this.view.bindRegister(this.handleRegister.bind(this))}async handleRegister({name:e,email:t,password:n}){try{await this.authService.register({name:e,email:t,password:n});const a=await this.authService.login({email:t,password:n});localStorage.setItem("token",a.loginResult.token),localStorage.setItem("userName",a.loginResult.name),this.navigate("/")}catch(e){this.view.showError(e.message)}}}class G{constructor(e){this.template=e,this.map=null}renderBaseTemplate(){document.querySelector("#main-content").innerHTML=`\n    ${this.template.detailTemplate()}\n    <div id="image-modal" style="\n      display:none;\n      position:fixed;\n      top:0; left:0; right:0; bottom:0;\n      background:rgba(0,0,0,0.85);\n      justify-content:center;\n      align-items:center;\n      z-index:10000;\n    ">\n      <img id="modal-image" src="" alt="Full Image" style="\n        max-width:90vw;\n        max-height:90vh;\n        box-shadow:0 0 20px rgba(255,255,255,0.5);\n        border-radius:8px;\n      "/>\n    </div>\n  `,document.getElementById("image-modal").addEventListener("click",(()=>{document.getElementById("image-modal").style.display="none"}))}showLoading(){const e=document.querySelector(".story-detail");e&&e.classList.add("loading")}hideLoading(){const e=document.querySelector(".story-detail");e&&e.classList.remove("loading")}showError(e){document.querySelector("#main-content").innerHTML=`\n      <div class="error">\n        <h2>Error</h2>\n        <p>${e}</p>\n      </div>\n    `}renderStory(e){document.getElementById("story-title").textContent=e.name;const t=document.getElementById("story-image");t.src=e.photoUrl,t.alt=e.name,t.style.cursor="zoom-in",t.addEventListener("click",(()=>{const t=document.getElementById("image-modal");document.getElementById("modal-image").src=e.photoUrl,t.style.display="flex"})),document.getElementById("story-desc").textContent=e.description,document.getElementById("story-date").textContent=new Date(e.createdAt).toLocaleString()}renderMap(e,t){this.map&&this.map.remove(),this.map=L.map("story-map").setView([e,t],13),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(this.map),L.marker([e,t]).addTo(this.map)}bindCommentSubmit(e){document.getElementById("commentForm").addEventListener("submit",(t=>{t.preventDefault();const n=document.getElementById("comment-input").value.trim();e(n)}))}bindCommentDelete(e){document.getElementById("comment-list").addEventListener("click",(t=>{if(t.target.matches(".delete-comment")){const n=t.target.dataset.cid;e(n)}}))}renderComments(e){const t=document.getElementById("comment-list");e.length?t.innerHTML=e.map((e=>`\n      <li class="comment-item" style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1rem;">\n        <div>  \n      <strong>${e.author}</strong>\n      <small style="margin-left:0.5rem;color:#666;"> ${new Date(e.createdAt).toLocaleString()}</small>\n        <p style="margin:0.5rem 0 0 0;">${e.text}</p>\n        </div>\n       <button class="btn btn-sm btn-danger delete-comment" data-cid="${e.cid}" style="margin-left:1rem;align-self:flex-start;">🗑️</button>\n      </li>\n    `)).join(""):t.innerHTML="<li>Belum ada komentar.</li>"}clearCommentInput(){document.getElementById("comment-input").value=""}}class N{constructor(e,{storyService:t,navigate:n}){this.view=e,this.storyService=t,this.navigate=n}async initialize(e){this.view.showLoading();try{this.view.renderBaseTemplate();const t=await this.storyService.getStoryById(e);this.view.renderStory(t),this.view.renderMap(t.lat,t.lon),this.view.bindCommentSubmit((t=>this.handleNewComment(e,t))),this.view.bindCommentDelete((t=>this.handleDeleteComment(e,t)));const n=await v(e);this.view.renderComments(n)}catch(e){this.view.showError(e.message)}finally{this.view.hideLoading()}}async handleNewComment(e,t){if(!t)return;const n={cid:(0,f.A)(),storyId:e,author:localStorage.getItem("userName")||"Guest",text:t,createdAt:(new Date).toISOString()};await async function(e){return(await u()).put(m,e)}(n);const a=await v(e);this.view.renderComments(a),this.view.clearCommentInput()}async handleDeleteComment(e,t){await async function(e){return(await u()).delete(m,e)}(t);const n=await v(e);this.view.renderComments(n)}}function O(e){const t=e.split("/");return{resource:t[1]||null,id:t[2]||null}}function q(){return location.hash.replace("#","")||"/"}class R{render(){return'\n        <section class="container">\n          <h1 class="page-title">Drafts Anda</h1>\n          <div class="draft-list"></div>\n        </section>\n      '}card(e){return`\n        <article class="draft-card">\n          <p><strong>Deskripsi:</strong> ${e.description}</p>\n          <p><strong>Dibuat:</strong> ${new Date(e.createdAt).toLocaleString()}</p>\n          <button id="delete-${e.id}" class="btn btn-danger">Hapus Draft</button>\n        </article>\n      `}}class j{constructor(e){this.template=e}renderDrafts(e){const t=document.querySelector(".draft-list");e.length?(t.innerHTML=e.map((e=>this.template.card(e))).join(""),e.forEach((e=>{document.getElementById(`delete-${e.id}`).addEventListener("click",(()=>this.onDelete(e.id)))}))):t.innerHTML="<p>Tidak ada draft.</p>"}bindDelete(e){this.onDelete=e}}class z{constructor(e){this.view=e,this.view.bindDelete(this.handleDelete.bind(this))}async loadDrafts(){const e=await p();this.view.renderDrafts(e)}async handleDelete(e){await g(e),await this.loadDrafts()}}const _={"/":class{constructor(){this.template=new a,this.view=new o(this.template),this.presenter=null}initPresenter({storyService:e,navigate:t}){return this.presenter=new y(this.view,e),this.view.bindAddButton((e=>{t("/add")})),this.presenter}async render(){const e=!localStorage.getItem("token")&&"true"===localStorage.getItem("isGuest"),t=localStorage.getItem("userName")||"Guest";return this.template.baseTemplate(e,t)}async afterRender(){await this.presenter.initialize()}},"/add":class{constructor(){this.template=new w,this.view=new b(this.template),this.presenter=null}initPresenter({storyService:e,navigate:t}){return this.presenter=new S(this.view,{storyService:e,navigate:t}),this.presenter.saveDraft=this.#e.bind(this),this.presenter.loadDrafts=this.#t.bind(this),this.presenter.deleteDraft=this.#n.bind(this),this.presenter}async render(){return this.view.render()}async afterRender(){this.presenter.init();const e=await p(),t=document.querySelector("#draft-list");t&&e.length&&(t.innerHTML=e.map((e=>`\n        <div class="draft-item">\n          <p>${e.description}</p>\n          <button class="use-draft" data-id="${e.id}">Gunakan</button>\n          <button class="delete-draft" data-id="${e.id}">Hapus</button>\n        </div>\n      `)).join(""),t.addEventListener("click",(async t=>{const n=t.target.dataset.id;if(t.target.classList.contains("use-draft")){const t=e.find((e=>e.id===n));t&&(document.querySelector("#description").value=t.description,t.lat&&t.lon&&(document.querySelector("#lat").value=t.lat,document.querySelector("#lon").value=t.lon))}t.target.classList.contains("delete-draft")&&(await this.#n(n),window.location.reload())})))}async#e(e){const t={id:(0,f.A)(),...e,createdAt:(new Date).toISOString()};await h(t)}async#t(){return await p()}async#n(e){return await g(e)}},"/login":class{constructor(){this.template=new x,this.view=new k,this.presenter=null}async render(){return this.template.render()}initPresenter(e){return new C(this.view,{authService:T,navigate:e.navigate})}async afterRender(){const e=document.getElementById("loginForm");e&&e.addEventListener("submit",(async e=>{e.preventDefault();try{const e={email:document.getElementById("email").value,password:document.getElementById("password").value},t=await T.login(e);localStorage.setItem("token",t.loginResult.token),localStorage.setItem("userName",t.loginResult.name),window.location.hash="#/"}catch(e){alert(e.message)}}));const t=document.querySelector(".guest-button");t&&t.addEventListener("click",(e=>{e.preventDefault(),localStorage.setItem("isGuest","true"),localStorage.setItem("userName","Guest"),localStorage.removeItem("token"),window.location.hash="#/"}))}},"/register":class{constructor(){this.template=new M,this.view=new A(this.template),this.presenter=null}initPresenter({authService:e,navigate:t}){return this.presenter=new $(this.view,{authService:e,navigate:t}),this.presenter}async render(){return this.view.render()}async afterRender(){this.presenter.init()}},"/stories/:id":class{constructor(){this.template=new w,this.view=new G(this.template),this.presenter=null}initPresenter(e){return this.presenter=new N(this.view,e),this.presenter}async render(){return this.template.detailTemplate()}async afterRender(){const{id:e}=O(q());await this.presenter.initialize(e)}},"/drafts":class{constructor(){this.template=new R,this.view=new j(this.template),this.presenter=new z(this.view)}initPresenter(){return this.presenter}async render(){return this.template.render()}async afterRender(){await this.presenter.loadDrafts()}},"/404":class{async render(){return'\n      <div class="error-page">\n        <div class="error-content">\n          <h1 class="error-title">404</h1>\n          <h2 class="error-subtitle">Halaman Tidak Ditemukan</h2>\n          <p class="error-description">\n            Maaf, halaman yang Anda cari tidak dapat ditemukan.\n          </p>\n          <a href="#/" class="home-link">\n            <i class="fas fa-home"></i> Kembali ke Beranda\n          </a>\n        </div>\n      </div>\n    '}initPresenter(e){return{cleanup:()=>{}}}async afterRender(){this.#a()}#a(){const e=document.createElement("style");e.textContent="\n      .error-page {\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        min-height: 60vh;\n        text-align: center;\n        padding: 2rem;\n      }\n      \n      .error-content {\n        max-width: 500px;\n      }\n      \n      .error-title {\n        font-size: 6rem;\n        font-weight: bold;\n        color: #ff6b6b;\n        margin: 0;\n        line-height: 1;\n      }\n      \n      .error-subtitle {\n        font-size: 1.5rem;\n        color: #333;\n        margin: 1rem 0;\n      }\n      \n      .error-description {\n        color: #666;\n        margin: 1.5rem 0;\n        line-height: 1.6;\n      }\n      \n      .home-link {\n        display: inline-block;\n        background: #007bff;\n        color: white;\n        text-decoration: none;\n        padding: 12px 24px;\n        border-radius: 6px;\n        transition: background-color 0.3s ease;\n        margin-top: 1rem;\n      }\n      \n      .home-link:hover {\n        background: #0056b3;\n        color: white;\n      }\n      \n      .home-link i {\n        margin-right: 8px;\n      }\n    ",document.querySelector("#error-page-styles")||(e.id="error-page-styles",document.head.appendChild(e))}}},F="push-endpoint";function H(){return!!localStorage.getItem(F)}class V{#i;#r;#s;#o=null;#l=!1;constructor({navigationDrawer:e,drawerButton:t,content:n}){if(!e||!n)throw new Error("Required elements missing!");this.#i=n,this.#r=t,this.#s=e,this.#c()}#c(){this.#d(),this.#m(),this.#u(),this.#h()}#d(){this.#p(),this.#g(),this.#v()}#m(){window.addEventListener("hashchange",(()=>this.#y())),document.addEventListener("click",this.#w.bind(this)),this.#s.addEventListener("click",this.#b.bind(this))}#h(){this.#y(),this.#f()}#y=async()=>{this.#g(),this.#v(),await this.#S()};#w(e){e.target.matches("#logout-btn")&&this.#k(),e.target.matches("#login-page-btn")&&this.#I()}#b(e){if(e.target.matches("a.drawer-link")){e.preventDefault();const t=e.target.getAttribute("href")?.replace("#","");t&&(window.location.hash=t)}}#k(){"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((e=>e.pushManager.getSubscription())).then((e=>e?.unsubscribe())).catch(console.error),T.unregisterPush().catch((e=>console.error("UnregisterPush failed:",e))),localStorage.clear(),this.#E("/login",!0)}#I(){localStorage.setItem("isGuest","true"),this.#E("/",!0)}#E(e,t=!1){window.location.hash=e,t&&window.location.reload()}async#S(){try{const e=function(e){let t="";return e.resource&&(t=t.concat(`/${e.resource}`)),e.id&&(t=t.concat("/:id")),t||"/"}(O(q())),t=_[e]||_["/404"];await this.#L(),await this.#B(t)}catch(e){this.#D(e)}}async#L(){this.#o?.cleanup&&await this.#o.cleanup(),this.#o=null}async#B(e){const t=new e,n=await t.render();await this.#T((()=>{this.#i.innerHTML=n})),this.#o=this.#P(t),await t.afterRender(),this.#v()}#P(e){if("function"==typeof e.initPresenter)try{return e.initPresenter({authService:T,storyService:P,navigate:this.#E.bind(this)})}catch(e){return console.warn("Error initializing presenter for page:",e),null}return null}async#T(e){document.startViewTransition?await document.startViewTransition(e).finished:await this.#C(e)}async#C(e){const t=this.#i.animate([{opacity:1},{opacity:0}],{duration:150,easing:"ease-out"});await t.finished,e(),this.#i.animate([{opacity:0},{opacity:1}],{duration:150,easing:"ease-in"})}#D(e){console.error("Render error:",e),this.#i.innerHTML=this.#x(e)}#x(e){return`\n      <div class="error-page">\n        <h2>😞 Oops, terjadi kesalahan!</h2>\n        <p>${e.message}</p>\n        <a href="#/" class="home-link">Kembali ke Beranda</a>\n      </div>\n    `}#v(){this.#M(),this.#A()}#M(){const e=document.querySelector(".auth-section");if(!e)return;e.innerHTML=this.#$({isGuest:"true"===localStorage.getItem("isGuest"),hasToken:!!localStorage.getItem("token"),userName:localStorage.getItem("userName")||"Guest"});const t=document.getElementById("push-toggle-btn");t&&(t.style.display=localStorage.getItem("token")?"":"none")}#$({isGuest:e,hasToken:t,userName:n}){return t?this.#G(n):e?this.#N():this.#O()}#G(e){return`\n      <span class="username">${e}</span>\n      <button id="logout-btn" class="nav-button">\n        Logout <i class="fas fa-sign-out-alt"></i>\n      </button>\n    `}#N(){return'\n      <a href="#/login" class="nav-link">\n        Login <i class="fas fa-sign-in-alt"></i>\n      </a>\n    '}#O(){return'\n      <a href="#/login" class="nav-link">\n        Login <i class="fas fa-sign-in-alt"></i>\n      </a>\n      <a href="#/register" class="nav-link register-btn">\n        Register <i class="fas fa-user-plus"></i>\n      </a>\n    '}#u(){const e=document.getElementById("push-toggle-btn");if(!e)return;const t=()=>{e.textContent=H()?"Unsubscribe 🔕":"Subscribe 🔔"};t(),e.addEventListener("click",(async()=>{try{e.disabled=!0,H()?await async function(){if(!("serviceWorker"in navigator))return;const e=await navigator.serviceWorker.ready,t=await e.pushManager.getSubscription();t&&(await t.unsubscribe(),await T.unregisterPush()),localStorage.removeItem(F)}():await async function(){if(!("serviceWorker"in navigator)||!("PushManager"in window))throw new Error("Push not supported");const e=await navigator.serviceWorker.ready,t=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:E(I)});return await T.registerPush(t),localStorage.setItem(F,t.endpoint),t.endpoint}(),t()}catch(e){console.error("Push toggle failed:",e),alert("Gagal mengubah notifikasi: "+e.message)}finally{e.disabled=!1}}))}#A(){const e=this.#s.querySelector('a[href="#/login"]')?.parentElement,t=!!localStorage.getItem("token");e?.classList.toggle("hidden",t)}#g(){const e=window.location.hash.replace("#","")||"/",t="true"===localStorage.getItem("isGuest"),n=!!localStorage.getItem("token");!["/","/add"].includes(e)||n||t||this.#E("/login"),["/login","/register"].includes(e)&&n&&this.#E("/")}#f(){const e=new CustomEvent("auth-state-changed",{detail:{isLoggedIn:!!localStorage.getItem("token"),isGuest:"true"===localStorage.getItem("isGuest")}});document.dispatchEvent(e)}#p(){this.#r.addEventListener("click",(()=>{this.#s.classList.toggle("navigation-drawer--open"),this.#i.classList.toggle("main-content--drawer-open")})),document.addEventListener("click",(e=>{this.#s.contains(e.target)||this.#r.contains(e.target)||(this.#s.classList.remove("navigation-drawer--open"),this.#i.classList.remove("main-content--drawer-open"))}))}}document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector("#main-content"),t=document.querySelector("#drawer-button"),n=document.querySelector("#navigation-drawer");e&&n?new V({navigationDrawer:n,drawerButton:t,content:e}):console.error("Elemen penting tidak ditemukan!")}))}},n={};function a(e){var i=n[e];if(void 0!==i)return i.exports;var r=n[e]={exports:{}};return t[e].call(r.exports,r,r.exports,a),r.exports}a.m=t,e=[],a.O=(t,n,i,r)=>{if(!n){var s=1/0;for(d=0;d<e.length;d++){for(var[n,i,r]=e[d],o=!0,l=0;l<n.length;l++)(!1&r||s>=r)&&Object.keys(a.O).every((e=>a.O[e](n[l])))?n.splice(l--,1):(o=!1,r<s&&(s=r));if(o){e.splice(d--,1);var c=i();void 0!==c&&(t=c)}}return t}r=r||0;for(var d=e.length;d>0&&e[d-1][2]>r;d--)e[d]=e[d-1];e[d]=[n,i,r]},a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={524:0};a.O.j=t=>0===e[t];var t=(t,n)=>{var i,r,[s,o,l]=n,c=0;if(s.some((t=>0!==e[t]))){for(i in o)a.o(o,i)&&(a.m[i]=o[i]);if(l)var d=l(a)}for(t&&t(n);c<s.length;c++)r=s[c],a.o(e,r)&&e[r]&&e[r][0](),e[r]=0;return a.O(d)},n=self.webpackChunkstory_app=self.webpackChunkstory_app||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();var i=a.O(void 0,[758],(()=>a(683)));i=a.O(i)})();